name: Cross-Compile Build (Self-Hosted)

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted # Use the self-hosted runner
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin # macOS Intel
            artifact_name: acp-script-macos-x86_64
          - target: aarch64-apple-darwin # macOS ARM64
            artifact_name: acp-script-macos-arm64
          - target: x86_64-unknown-linux-musl #Linux using MUSL.
            artifact_name: acp-script-linux-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust #This is now installing and setupping components using a Github Action.
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build for ${{ matrix.target }}
        run: |
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then
              echo "RUSTFLAGS=-C linker=/opt/homebrew/opt/musl-cross/bin/x86_64-linux-musl-gcc" >> "$GITHUB_ENV"
          fi
          cargo build --release --target ${{ matrix.target }}
        env: # Moved RUSTFLAGS inside.  Only relevant during cargo build
          RUSTFLAGS: "-C target-feature=+crt-static"

      - name: Create Universal Binary (macOS)
        if: matrix.target == 'aarch64-apple-darwin'
        run: |
          # Wait for x86_64 build (file check, as before)
          while [ ! -f "target/x86_64-apple-darwin/release/${{ matrix.artifact_name }}" ]; do
            sleep 5
          done
          lipo -create \
            "target/x86_64-apple-darwin/release/${{ matrix.artifact_name }}" \
            "target/aarch64-apple-darwin/release/${{ matrix.artifact_name }}" \
            -output "universal-${{ matrix.artifact_name }}"
          mv "universal-${{ matrix.artifact_name }}" ${{ matrix.artifact_name }}-universal
        shell: bash

      - name: Package Binary (Exclude aarch64 on macOS)
        if: matrix.target != 'aarch64-apple-darwin'
        run: |
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then #copy executable.
              mv target/${{ matrix.target }}/release/${{ matrix.artifact_name }} ${{ matrix.artifact_name }}
          fi
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then #copy executable.
              mv target/x86_64-unknown-linux-musl/release/${{ matrix.artifact_name }} ${{ matrix.artifact_name }}
          fi

      - name: Upload Release Asset (conditional name)
        if: matrix.target != 'aarch64-apple-darwin'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact_name }} # Conditional file name

      - name: Upload aarch64 universal file #Separate step, conditional skipped previously
        if: matrix.target == 'aarch64-apple-darwin' #Avoid multiple artifacts uploads
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact_name }}-universal # Conditional file name
